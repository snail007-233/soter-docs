<!DOCTYPE html>
<html>
	<head>
		<title>Soter官方拓展包</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="js/inc.js"></script>
	</head>
	<body>
		<fieldset>
			<legend>Soter官方功能拓展包</legend>
			<ol>
				<li><h2 class="title_h2">概念</h2>
					一些非核心功能，比如：验证码，http封装。Soter把这些可选功能作为拓展包的形式提供，
					<br>要使用这些功能，需要下载官方拓展包后才能使用。
					<br>官方拓展包Git@OSC地址：<a href="http://git.oschina.net/snail/soter-extensions" target="_blank">Git@OSC</a>
					<br>官方拓展包Git@Github地址：<a href="http://github.com/snail007/soter-extensions" target="_blank">Git@Github</a>
				</li>
				<li><h2 class="title_h2">安装拓展包</h2>
					1.下载拓展包zip文件，然后解压，比如解压后是：/home/soter/extensions
					<br>2.复制文件夹extensions到soter项目的application/packages/里面
					<br>3.启用extensions，在入口文件里面修改addPackages，增加extensions
					<br>比如下面：
					<pre class="brush:php">
						/* 注册拓展包 */  
						->addPackages(array(  
						    ....  
						    SOTER_PACKAGES_PATH . 'extensions',  
						    ...  
						))  
					</pre>
				</li>
				<li><h2 class="title_h2">加载拓展包类库</h2>
					可以通过<code>Sr::extension('类名称')</code>加载一个拓展包里面的类，
					<br>你应该发现了官方功能拓展包里面的类都有Soter_前缀,
					<br>这里的参数“类名称”是不需要Soter前缀的。
					<br>比如：
					<br>类文件：application/packages/extensions/classes/Soter/Captcha.php
					<br>那么可以用下面的代码加载：
					<pre class="brush:php">
						Sr::extension('Captcha')	
					</pre>
				</li>
				<li><h2 class="title_h2">验证码</h2>
					验证码是拓展包提供的功能，需要安装拓展包才能使用。
					<br>可以通过<code>Sr::extension('Captcha')</code>实例化一个验证码类。
					<br>使用方法，比如下面的代码：
					<pre class="brush:php">
						// 1.完整示例
						$image=Sr::extension('Captcha');
						$image->config('宽度','高度','字符个数','验证码session索引');
						$code=$image->create();//这样就会向浏览器输出一张图片,并返回验证码图片上的内容
						//2.简单示例:
						$image=Sr::extension('Captcha');
						$image->create();//这样就会向浏览器输出一张图片	
					</pre>
					提示：
					<br><b>1.所有参数都可以省略</b>
					<br>默认是：宽80 高20 字符数4 验证码$_SESSION键名称captcha_code
					<br>第四个参数即把验证码存到$_SESSION['captcha_code'],第四个参数如果为null，则不会在$_SESSION中设置验证码。
					<br>当第四个参数是null的时候，可以通过<code>$image->getCheckCode()</code>获取写到图片上的验证码字符串
					<br><b>2.设置验证码组成</b>
					<br>验证码组成类型，有三种：1.number（纯数字） 2.letter（纯字母） 3.both（数字和数字）
					<br>默认是：both
					<br>可以通过$image->setCodeMode('类型')进行设置
					<br>比如下面的代码：
					<pre class="brush:php">
						$image=Sr::extension('Captcha');
						$image->setCodeMode('number')
							->config('宽度','高度','字符个数','验证码session索引')
						$code=$image->create();//这样就会向浏览器输出一张图片,并返回验证码图片上的内容
					</pre>
				</li>
                                <li>
                                        <h2 class="title_h2">HTTP操作类</h2>
                                        主要功能：
                                        <br>1.模拟登录，cookie自动管理，也可以手动结合自动管理cookie。
                                        <br>2.抓取数据，支持get，post。
                                        <br>特点：
                                        <br>1.基于CURL
                                        <br>2.使用方便灵活，即使禁止了CURL的自动30x跳转处理，该类也能正常处理30x重定向。
                                        <br><b class="text_strong">示例如下：</b>
                                        <br><b>1.get</b>
                                        <pre class="brush:php">
                                                $http = Sr::extension('Http');
                                                //返回的是页面内容
                                                $data = $http->get('https://www.baidu.com/');                                                
                                                //如果有传递数据，可以传递第二个参数
                                                $args['code'] = '1';
                                                $data = $http->get('https://baidu.com/',$args);
                                                //如果要设置本次请求的头部信息，可以传递第三个参数
                                                //$header是附加的HTTP头，比如：array('Connection:keep-alive','Cache-Control:max-age=0')，注意冒号前后不能有空格，默认 null
                                                $header = array('Connection:keep-alive','Cache-Control:max-age=0');
                                                $data = $http->get('https://baidu.com/',null,$header);
                                                //默认get和post是不自动处理30x跳转的，可以通过指定第四个参数来控制遇到301或302时跳转的最大次数，默认 0 不跳转
                                                $data = $http->get('https://baidu.com/',null,null,1);
                                        </pre>
                                        <b>2.post</b>
                                        <pre class="brush:php">
                                                $http = Sr::extension('Http');
                                                $user = '用户名';
                                                $pass = '密码';
                                                $data['user_login'] = $user;
                                                $data['user_pwd'] = md5($pass);
                                                $data=$http->setReferer('http://www.liepin.com/')->post('http://www.liepin.com/user/ajaxlogin/', $data);
                                                var_dump($data);
                                                $error_code=$http->errorCode();//获取curl出错代码（大于零的数），如果没有错误，返回0
                                                $error_msg=$http->errorMsg();  //获取curl出错字符串信息，如果没有错误，返回空
                                                $http_code=$http->code();      //返回的http状态码
                                                if($error_code){
                                                    exit($error_msg);
                                                }
                                                $is_redirect=$http->isRedirect();//是否是重定向
                                                if($is_redirect){
                                                    //do something
                                                    $http_location=$http->location();//获取重定向的地址
                                                }else{
                                                    //do something
                                                }
                                        </pre>
                                        <b>3.模拟登录 猎聘网 并抓取简历</b>
                                        <br>1.新建Functions函数文件application/functions/liepin.php
                                        <br>输入以下代码：
                                        <pre class="brush:php">
                                                &lt;?php

                                                /**
                                                * 猎聘网
                                                * @param type $user
                                                * @param type $pass
                                                * @param type $save_path
                                                * @param type $error_msg
                                                * @return boolean
                                                */
                                                function liepin($user, $pass, $save_path, &$error_msg) {
                                                        include_once 'simple_html_dom.php';//可以到https://github.com/samacs/simple_html_dom里面去下载
                                                        $http = Sr::extension('Http');
                                                        $data['isMd5'] = 1;
                                                        $data['layer_from'] = 'wwwindex_rightbox_new';
                                                        $data['user_login'] = $user;
                                                        $data['user_pwd'] = md5($pass);
                                                        $data['chk_remember_pwd'] = 'on';
                                                        $http->setReferer('http://www.liepin.com/')->post('http://www.liepin.com/user/ajaxlogin/', $data);
                                                        $index = $http->get('http://c.liepin.com/');
                                                        $html = str_get_html($index);
                                                        $e = $html->find('a[href^=/resume/download?res_id_encode]', 0);
                                                        if ($e && $e->href) {
                                                                //登录成功
                                                                //下载简历
                                                                $doc = $http->setReferer('http://www.liepin.com/')->get('http://c.liepin.com' . $e->href);
                                                                if ($doc) {
                                                                        file_put_contents($save_path, $doc);
                                                                        $error_msg = null;
                                                                        return true;
                                                                } else {
                                                                        //获取简历失败
                                                                        $error_msg = '获取简历失败';
                                                                        return false;
                                                                }
                                                        } else {
                                                                //登录失败
                                                                $error_msg = '登录失败或者简历可能为空';
                                                                return false;
                                                        }
                                                } 
                                        </pre>
                                        2.创建控制器文件application/classes/Controller/Welcome.php 
                                        <pre class="brush:php">
                                                &lt;?php

                                                class Controller_Welcome extends Soter_Controller {

                                                        public function do_liepins() {
                                                                Sr::functions('liepin');
                                                                $error_msg = '';
                                                                if (liepin('用户名', '密码', 'zhaopin_resume.doc', $error_msg)) {
                                                                        echo 'okay';
                                                                } else {
                                                                        echo $error_msg;
                                                                }
                                                        }
                                                }  
                                        </pre>
                                </li>
			</ol>
		</fieldset>
		<script src="js/inc.foot.js"></script>
	</body>
</html>
